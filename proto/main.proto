syntax = "proto3";
package snowballr;

import "authentication.proto";
import "base.proto";
import "criterion.proto";
import "export.proto";
import "paper.proto";
import "project.proto";
import "review.proto";
import "user.proto";
import "user_settings.proto";

// SnowballR is a tool aiming to assist in scientific research by organizing
// and managing structured literature reviews. The application is split into
// a web frontend and a backend on a central server keeping track of all data.
// This service represents all available interactions between the frontend and
// backend.
// Unless stated otherwise, **every** call **requires** the user to be
// **authenticated**. This shall be achieved by providing a valid access token
// assigned by the server (see [Login](#service-snowballr.SnowballR-Login)) in
// the `Authorization` header.
// Every call looking up an entity using a unique identifier may fail with a
// `NOT_FOUND` error if no entity with the provided identifier could be located.
// This also includes calls returning data based on the looked up entity.
// Every enum contains a `_UNSPECIFIED` variant indicating its absence.
// If any other variant is present, the field is considered to be _specified_.
// The word _guaranteed_ may only convey meaning in the context of this
// contract. Due to the nature of the underlying network communication, a result
// may never be really guaranteed and proper error handling is advised. In the
// following, _guaranteed_ shall denote a situation in which the client shall
// be able to safely make assumptions about a successfully received message.
// 
// ~~~mermaid
// architecture-beta
//  group frontend(internet)[Frontend]
//  service browser(internet)[Browser] in frontend
// 
//  group backend(server)[Backend]
//  service server(server)[SnowballR Server] in backend
//  service db(database)[Database] in backend
//
//  group external(internet)[External Resources]
//  service fetcher1(internet)[External Paper Database 1] in external
//  service fetcher2(internet)[External Paper Database 2] in external
// 
//  junction j1 in external
//  junction j2 in external
// 
//  browser:R --> L:server
// 
//  server:B --> T:db
//  server:R -- L:j1
// 
//  j1:R -- L:j2
//  j1:B --> T:fetcher1
//  j2:B --> T:fetcher2
// ~~~
// The SnowballR application is split into a frontend and a backend. The
// frontend is a web page that runs in the browser of a client. The backend
// runs on a server and contains most if not all logic. It accesses a database
// to persist data and makes requests to external resources like paper
// databases.
//
// ~~~mermaid
// erDiagram
//  direction LR
// 
//  Project 0+ -- 0+ User : "member of"
//  Project 1 -- 1 ProjectSettings : has
//  Project 1 -- 0+ ProjectPaper : contains
//  Project 1 -- 0+ Criterion : contains
// 
//  ProjectSettings 0+ -- 1+ FetcherApi : "fetches from"
// 
//  ProjectPaper 1 -- 0+ Review : has
//  ProjectPaper 1 -- 1 Paper : "refers to"
// 
//  Review 0+ -- 1 User : by
//  Review 0+ -- 0+ Criterion : "ticks off"
// 
//  User 1 -- 1 UserSettings : has
//  User 0+ -- 0+ Paper : "reading-list"
// ~~~
// This figure shows the relationships between entities/concepts of the
// SnowballR application. It is not the actual database schema SnowballR's
// backend is using and solely assists with understanding the broader picture.
service SnowballR {
  // Query all available origins a paper may be sourced from by the backend.
  // Each source is identified by a unique string and is later used to specify
  // which services shall be used by a project to collect papers. The list is
  // **guaranteed** to be **non-empty** but **may change** over time.
  rpc GetAvailableFetcherApis (Nothing) returns (AvailableFetcherApis);
  
  // Create an account for this SnowballR instance. The provided
  // **email must not be already registered** and
  // **every field must not be empty**. If successful, access tokens are
  // provided which are automatically used by following calls.
  //
  // This call does not require the user to be authenticated.
  rpc Register (RegisterRequest) returns (Nothing);

  // If email and password exactly match a user in the server's database, a
  // new set of access tokens is provided to authenticate as that user. Old
  // access and refresh tokens shall remain valid. These credentials are handled
  // automatically and do not need  further attention.
  // 
  // This call does not require the user to be authenticated.
  rpc Login (LoginRequest) returns (Nothing);
  
  // Revoke access through the currently used set of access and refresh token.
  // Other token pairs may not be affected.
  rpc Logout (Nothing) returns (Nothing);
  
  // Acquire the clients authentication status. The result is **guaranteed** to
  // be **specified**.
  //
  // This call does not require the user to be authenticated.
  rpc GetAuthenticationStatus (Nothing) returns (AuthenticationStatusResponse);

  // Upon presentation of a valid refresh token, a new set of access tokens
  // authenticating the owner of the token is issued. The new pair is
  // **guaranteed** to contain valid credentials. The refresh token **may
  // change** too. These credentials are handled automatically and do not need
  // further attention.
  //
  // Use this call if the access token is expired.
  // This call does not require the user to be authenticated.
  rpc RenewSession (Nothing) returns (Nothing);

  // If the provided email address is registered as an active user, a
  // challange/token is emailed to that address. That token must be sent
  // alongside a new password
  // (see [ResetPassword](#service-snowballr.SnowballR-ResetPassword)) in order
  // to update a lost or forgotten password.
  //
  // This call does not require the user to be authenticated.
  rpc RequestPasswordReset (RequestPasswordResetRequest) returns (Nothing);
  
  // After requesting a password reset email using
  // [RequestPasswordReset](#service-snowballr.SnowballR-RequestPasswordReset),
  // this call may be used to actually set the new password. To verify the
  // ownership of the account, the token sent via email must also be provided
  // and valid. The new password must follow the same rules as during
  // [registration](#service-snowballr.SnowballR-Register).
  //
  // This call does not require the user to be authenticated.
  rpc ResetPassword (PasswordResetRequest) returns (Nothing);

  // Use a valid access token and the old password in order to set a new
  // password. The new password must follow the same rules as during
  // [registration](#service-snowballr.SnowballR-Register). This serves no
  // recovery purpose and is for user convenience only.
  rpc ChangePassword (PasswordChangeRequest) returns (Nothing);

  // Get all registered users of this SnowballR instance.
  // There is currently no specific user role required to make this call, but
  // that may be **subject to change**.
  rpc GetAllUsers (Nothing) returns (User.List);

  // Get the currently authenticated user by looking up the provided access
  // token. If properly authenticated, it is **guaranteed** to return a valid
  // user.
  rpc GetCurrentUser (Nothing) returns (User);

  // Returns the user with the specified id. If none is found, a `NOT_FOUND`
  // error is returned.
  rpc GetUserById (Id) returns (User);

  // Returns the user with the specified email address. If none is found, a
  // `NOT_FOUND` error is returned.
  rpc GetUserByEmail (Id) returns (User);

  // Update all in the field-mask specified attributes of the user with the
  // provided id except for status. This especially includes role and email. The
  // updated user is returned.
  rpc UpdateUser (User.Update) returns (User);

  // Prevents the user with the provided id from logging in. It is not fully
  // deleted from the database though.
  // The calling user is **required to be admin**.
  rpc SoftDeleteUser (Id) returns (Nothing);

  // Allows a previously soft-deleted user to login again.
  // The calling user is **required to be admin**.
  rpc SoftUndeleteUser (Id) returns (Nothing);

  
  // Get all papers the requesting user is able to review. It is not given that
  // the returned papers belong to the same project.
  rpc GetAllPapersToReview (Nothing) returns (Project.Paper.List);

  // Get all papers from a specific project the requesting user should review.
  rpc GetPapersToReviewForProject (Id) returns (Project.Paper.List);

  // Get the paper with the succeeding local id of the paper with the
  // provided global id. It is **guaranteed** that the returned paper is in the
  // same project as the provided one. If the provided paper is the last paper
  // in the project, a `NOT_FOUND` error is returned.
  rpc GetNextPaper (Id) returns (Project.Paper);

  // Get the next paper the calling user is able to review. Papers with lower
  // local ids are preferred. It is **guaranteed** that the returned paper is
  // in the same project as the one provided. If there is no reviewable paper
  // left in the project, a `NOT_FOUND` error is returned.
  rpc GetNextPaperToReview (Id) returns (Project.Paper);

  // Get the paper with the preceeding local id of the paper with the
  // provided global id. It is **guaranteed** that the returned paper is in the
  // same project as the provided one. If the provided paper is the first paper
  // in the project, a `NOT_FOUND` error is returned.
  rpc GetPreviousPaper (Id) returns (Project.Paper);

  // Get the previous paper with the preceding local id that still has
  // to be in review and is on the same stage. If there is no other paper
  // to be reviewed on the same page, the same criteria counts for the
  // previous stage and so on until there is no other paper to review in
  // the same stage and lower stages
  rpc GetPreviousPaperToReview (Id) returns (Project.Paper);

  // Gets the user-specific settings for the calling user. It is **guaranteed**
  // that the result is **specified**.
  rpc GetUserSettings (Nothing) returns (UserSettings);

  // Update all in the field-mask specified attributes of the calling user's
  // user settings. The updated user settings are directly returned and
  // **guaranteed** to be **specified**.
  rpc UpdateUserSettings (UserSettings.Update) returns (UserSettings);


  // Get the list of papers on the reading list of the calling user.
  rpc GetReadingList (Nothing) returns (Paper.List);
  
  // Returns whether or not the paper with the provided id is on the calling
  // user's reading list. If the provided id does not belong to a paper, `false`
  // will be returned.
  rpc IsPaperOnReadingList (Id) returns (BoolValue);
  
  // Adds the paper with the provided id to the calling user's reading list. If
  // the paper is already on the user's reading list, nothing will be changed
  // and **no error** will be returned. If no paper with the provided id exists,
  // a `NOT_FOUND` error is returned.
  rpc AddPaperToReadingList (Id) returns (Nothing);
  
  // Removes the paper with the provided id from the calling user's reading
  // list. If no paper with the provided id exists, nothing will be changed and
  // **no error** will be returned.
  rpc RemovePaperFromReadingList (Id) returns (Nothing);

  
  // Get a list of all projects the specified user was invited to.
  rpc GetPendingInvitationsForUser (Id) returns (Project.List);

  // Invite a user to a project. If the project does not exist, a `NOT_FOUND`
  // error is returned. The provided project has to be active, meaning
  // it is neither deleted nor archived. If this condition is not met, a
  // `FAILED_PRECONDITION` error is returned. If a user with the provided email
  // already exists, an invitation is sent. It is **not** instantly added to the
  // project. If, however, no user with the provided email exists, an invitation
  // email is sent out. The recipient may register on the SnowballR instance and
  // then accept the invitation. The calling user is **required to be a project
  // admin**.
  rpc InviteUserToProject (Project.Member.Invite) returns (Nothing);
  
  // Get a list of all users with a pending invitation to the provided project.
  // If the `id` field is specified, it is **guaranteed** that the user exists.
  // If, however, the `id` is empty, the user was invited by email and has not
  // yet registered on the instance.
  rpc GetPendingInvitationsForProject (Id) returns (User.List);

  // Get a list of all members of the specified project. Pending invitations
  // are **not** included.
  rpc GetProjectMembers (Id) returns (Project.Member.List);

  // Remove the specified user from the given project. If the user is not part
  // of the project, nothing happens. The calling user is **required to be a
  // project admin**.
  rpc RemoveProjectMember (Project.Member.Remove) returns (Nothing);


  // Get a list of all projects registered in the SnowballR instance.
  rpc GetAllProjects (Nothing) returns (Project.List);

  // Get a list of all projects in the SnowballR instance that are marked as
  // deleted.
  rpc GetAllDeletedProjects (Nothing) returns (Project.List);

  // Get a list of all projects the provided user is a member of and which are
  // marked as deleted.
  rpc GetAllDeletedProjectsForUser (Id) returns (Project.List);

  // Get a list of all projects in the SnowballR instance that are marked as
  // archived.
  rpc GetAllArchivedProjects (Nothing) returns (Project.List);

  // Get a list of all projects the provided user is a member of. Pending
  // invitations are **not** included.
  rpc GetAllProjectsForUser (Id) returns (Project.List);

  // Get a list of all archived projects the provided user is a member of.
  rpc GetAllArchivedProjectsForUser (Id) returns (Project.List);

  // Create a new project. The provided name has to be unique, otherwise an
  // `ALREADY_EXISTS` error is returned. The calling user is automatically a
  // member and a project admin of that project.
  rpc CreateProject (Project.Create) returns (Project);

  // Returns a project with the specified id.
  rpc GetProjectById (Id) returns (Project);

  // Update the project with the given id using the provided data. Only
  // fields specified in the field-mask will be updated. The following fields
  // cannot be modified: `current_stage`, `max_stage`. The updated
  // project is returned. The calling user is **required** to be a project
  // admin.
  rpc UpdateProject (Project.Update) returns (Project);

  // Export the provided project in the given format. A binary blob is returned.
  // The export includes all aspects of the project. Ideal for archiving and
  // comprehending.
  rpc ExportProject (ExportRequest) returns (Blob);

  // Mark a project as deleted. It is not fully deleted from the database and
  // may later be restored.
  // The calling user is **required to be a project admin**.
  rpc SoftDeleteProject (Id) returns (Nothing);
  
  // Restores a previously deleted project to the `active` state.
  // The calling user is **required to be a project admin**.
  rpc SoftUndeleteProject (Id) returns (Nothing);

  // Retreive information about the specified project. Only attributes
  // specified in the field-mask are included in the response.
  rpc GetProjectInformation (Project.Information.Get)
    returns (Project.Information);

  // Get the distribution of paper decisions within a project's stage.
  // Returns the number of papers for each possible `PaperDecision`.
  rpc GetDecisionStatisticsForStage (Project.Information.DecisionStatistics.Get)
    returns (Project.Information.DecisionStatistics);

  // Change the role of the user with the provided id within the given project.
  // The new role **must not** be **unspecified**.
  // The calling user is **required to be a project admin**.
  rpc UpdateProjectMemberRole (Project.Member.Update) returns (Nothing);

  
  // Get a criterion by its globally unique id.
  rpc GetCriterionById (Id) returns (Criterion);

  // Returns all criteria associated with a given project.
  rpc GetAllCriteriaForProject (Id) returns (Criterion.List);
  
  // Create a new criterion. Every field **must be specified** and non-empty,
  // otherwise an `INVALID_ARGUMENT` error is returned. If successfull, the
  // newly created criterion is returned. 
  // The calling user is **required to be a project admin**.
  rpc CreateCriterion (Criterion.Create) returns (Criterion);
  
  // Update the criterion with the given id using the provided data. Only
  // fields specified in the field-mask will be updated.
  // The calling user is **required to be a project admin**.
  rpc UpdateCriterion (Criterion.Update) returns (Criterion);

  // Permanently delete the specified criterion. All references to it will also
  // be removed. **This cannot be reversed**.
  // The calling user is **required to be a project admin**.
  rpc DeleteCriterion (Id) returns (Nothing);

  // Get a project paper using its globally unique id.
  rpc GetProjectPaperById (Id) returns (Project.Paper);

  // Get a project paper using the project id and the local id within that
  // project. Prefer `GetProjectPaperById` wherever possible.
  rpc GetProjectPaperByRelativeId (Project.Paper.Get) returns (Project.Paper);

  // Retreive all project papers associated with the given project.
  rpc GetAllProjectPapersForProject (Id) returns (Project.Paper.List);

  // Add the provided paper to the given project within the specified stage.
  // It is not checked whether or not that paper was previously added to the
  // project. The stage must be lesser or equal to the projects `max_stage`,
  // otherwise an `INVALID_ARGUMENT` error is returned.
  // The calling user is **required to be a project admin**.
  rpc AddPaperToProject (Project.Paper.Add) returns (Project.Paper);

  // Update the project paper with the specified globally unique id using the
  // provided data. Only fields specified in the field-mask will be updated,
  // excluding `local_id`, `decision` and `reviews`. The updated project will
  // be returned.
  // The calling user is **required to be a project admin**.
  rpc UpdateProjectPaper (Project.Paper.Update) returns (Project.Paper);

  // Permanently remove the specified project paper from the project. All
  // references to this project-paper will also be deleted. **This cannot be
  // undone**.
  // The calling user is **required to be a project admin**.
  rpc RemovePaperFromProject (Id) returns (Nothing);


  // Get a review using its globally unique id.
  rpc GetReviewById (Id) returns (Review);
  
  // Retreives all reviews for a specific project paper.
  rpc GetAllReviewsForProjectPaper (Id) returns (Review.List);
  
  // Create a new review for a specific project paper. The calling user must
  // not currently have another review for this project paper, otherwise a
  // `FAILED_PRECONDITION` error will be returned. The paper must also be
  // currently `UNREVIEWED` or `IN_REVIEW`, result in a `FAILED_PRECONDITION`
  // error if it is not. The user also has to be a member of the same project
  // the project paper belongs to, resulting in a `FAILED_PRECONDITION` error if
  // unmet. If successful, the created review is returned.
  rpc CreateReview (Review.Create) returns (Review);

  // Update the review with the given id using the provided data. Only
  // fields specified in the field-mask will be updated, excluding `user_id`.
  // The updated review is returned.
  // Only the owner of a review specified in `user_id` and a project admin are
  // allowed to update a review. The owner of the review has to be member of
  // the project the review is in, in order to update it.
  rpc UpdateReview (Review.Update) returns (Review);

  // Permanently remove the specified project paper from the project. All
  // references to this project-paper will also be deleted. **This cannot be
  // undone**.
  // Only the owner of a review specified in `user_id` and a project admin are
  // allowed to update a review. The owner of the review has to be member of
  // the project the review is in, in order to update it.
  rpc DeleteReview (Id) returns (Nothing);
  
  
  // Get a paper by its globally unique id.
  rpc GetPaperById (Id) returns (Paper);

  // Create a paper using the given data. The `id` will be ignored and set by
  // the server. All fields may be empty. The created paper will be returned.
  rpc CreatePaper (Paper) returns (Paper);

  // Update the paper with the given id using the provided data. Only
  // fields specified in the field-mask will be updated, excluding `has_pdf`.
  rpc UpdatePaper (Paper.Update) returns (Paper);

  // Returns a list of papers which are referring to the provided paper.
  rpc GetForwardReferencedPapers (Id) returns (Paper.List);

  // Returns a list of papers which are referred to by the provided paper.
  rpc GetBackwardReferencedPapers (Id) returns (Paper.List);

  // Returns a paper's pdf as a binary blob. If the specified paper has no
  // pdf attached to it (`has_pdf == false`), a `FAILED_PRECONDITION` error is
  // returned.
  rpc GetPaperPdf (Id) returns (Blob);

  // Sets or overwrites the pdf of the specified paper. This call may also be
  // used to remove the pdf of a paper by not specifying the `pdf` field.
  // The paper's `has_pdf` field is automatically updated by the server.
  rpc SetPaperPdf (Paper.PdfUpdate) returns (Nothing);
}

message AvailableFetcherApis {
  repeated string fetcher_apis = 1;
}

